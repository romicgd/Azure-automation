 $apps=(get-AzureADApplication -All $true)
 foreach($app in $apps) {
	$appid = "'"+$app.appid+"'"; $sp=(get-azureADServicePrincipal -Filter "AppId eq $appid"); 
	if($sp.objectid) {
		foreach($requiredResourceAccess in $sp.requiredresourceaccess) {
			$resourceAppId = $requiredResourceAccess.resourceAppId 
			$resourceappid = "'"+$resourceAppId+"'"; 
			$resourcesp=(get-azureADServicePrincipal -Filter "AppId eq $resourceappid"); 
			foreach($approle in $resourcesp.Oauth2Permissions) {
				foreach($resourceaccess in $requiredResourceAccess.resourceAccess) {
					if (($approle.id -eq $resourceAccess.id) -and ($resourceAccess.type -eq 'Scope')) {
						Write-output "$($sp.displayname),$($resourcesp.DisplayName),$($approle.Value)" | out-file ".\delegatedprivs.txt" -append
					}
				}
			}	
			foreach($approle in $resourcesp.AppRoles) {
				foreach($resourceaccess in $requiredResourceAccess.resourceAccess) {
					if (($approle.id -eq $resourceAccess.id) -and ($resourceAccess.type -eq 'Role')) {
						Write-output "$($sp.displayname),$($resourcesp.DisplayName),$($approle.Value)" | out-file ".\appprivs.txt" -append
					}
				}
			}	
		}	
	}
 }